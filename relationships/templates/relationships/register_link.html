{% extends 'extendables/base_simple.html' %}

{% load static %}

{% block main %}

<div class="d-flex flex-column flex-root">
    <div class="d-flex flex-column flex-column-fluid bgi-position-y-bottom position-x-center bgi-no-repeat bgi-size-contain bgi-attachment-fixed" style="background-image: url({% static 'common/assets/media/illustrations/sketchy-1/14.png' %}">
        <!--begin::Content-->
        <div class="d-flex flex-center flex-column flex-column-fluid p-10 pb-lg-20">
            <!--begin::Logo-->
            <a href="../../demo1/dist/index.html" class="mb-12">
                <img alt="Logo" src="{% static 'common/assets/media/logos/plain-logo.png' %}" class="h-40px" />
            </a>
            <!--end::Logo-->
            <!--begin::Wrapper-->
            <div class="w-lg-500px bg-body rounded shadow-sm p-10 p-lg-15 mx-auto">
                <!--begin::Form-->
                <form class="form w-100" action="{% url 'relationships:register_link' user_uuid %}" method="post">
                    {% csrf_token %}
                    <div class="text-center mb-10">
                        <h2 class="text-dark mb-3">We've sent you WhatsApp message, please reply 'yes' to complete registration.</h1>
                    </div>
                    <div class="fv-row mb-3">
                        <label for="whatsapp_phone_number" class="form-label fs-6 fw-bolder text-dark">Your WhatsApp Phone Number</label>
                        <div class="d-flex d-flex-column">
                            <input name="whatsapp_phone_number" class="form-control form-control-lg" type="text" placeholder="e.g., +14155552671" disabled="true" value="+{{ country_code }}{{ national_number }}" />
                        </div>
                    </div>
                    <div class="text-center">
                        <button type="submit" class="btn btn-lg btn-success w-100 mb-5" disabled="true" id="register_link__resend_button">
                            Resend Link via WhatsApp
                        </button>
                    </div>
                    <div class="row">
                        <div class="col-12">
                            Wait <span class="text-light-info fw-bolder bg-info" id="register_link__counter_seconds">60</span> seconds to resend link.
                        </div>
                        <div class="col-12 fw-bold mt-3">
                            Refresh this page if you're not automatically logged in after you've replied 'yes' to our message.
                        </div>
                    </div>
                </form>
                <!--end::Form-->
            </div>
            <!--end::Wrapper-->
        </div>
        <!--end::Content-->
    </div>
</div>

{% endblock %}

{% block page_custom_script %}

<script type="text/javascript">

var register_link__counter = function () {
    var start_counter = function() {
        var counter = 59; // Seconds (begins as 60 in HTML)
        var set_interval = setInterval(function() {
            $('#register_link__counter_seconds').html('' + counter);
            counter--;
            if (counter < 0) {
                clearInterval(set_interval); // Stop this counter
                $('#register_link__resend_button').removeAttr('disabled') // Enable resend button
            }
        }, 1000);
    };

    return {
        init: function () {
            start_counter();
        }
    }
}();

var register_link__poll_status = function() {
    var start_poll = function () {
        var counter = 500; // Poll for 33.3 minutes at most (500 * 4s = 33.3 mins)
        var set_interval = setInterval(function() {
            // Get register token and ascertain if it has been activated
            $.get("{% url 'relationships:confirm_register' user_uuid %}", function(data) {
                console.log(data);

                if (data['logged_in'] == true) {
                    window.location.replace("{% url 'leads__root:list' %}");
                }
            });
            counter--;
            if (counter < 0) {
                clearInterval(set_interval); // Stop this counter
            }
        }, 4000); // Poll every 4 seconds
    }

    return {
        init: function () {
            start_poll();
        }
    }
}();

jQuery(document).ready(function () {
    register_link__counter.init();
    register_link__poll_status.init();
});

</script>
{% endblock %}