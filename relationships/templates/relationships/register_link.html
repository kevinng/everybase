{% extends 'extendables/b.html' %}

{% load static %}

{% block title %}Confirm Register to Everybase{% endblock %}

{% block content %}
<div class="flex justify-center">
    <div class="bg-white max-w-md mt-10 w-full lg:rounded-xl p-10 shadow-md">
        <form action="{% url 'relationships:register_link' user_uuid %}" method="post">
            {% csrf_token %}
            {% if next is not None %}<input type="hidden" name="next" value="{{ next }}">{% endif %}{% comment %} The next URL is rendered with the template if it is passed as a GET parameter to the URL. {% endcomment %}
            <a href="https://everybase.co"><img class="mx-auto mt-5" src="{% static 'common/assets/img/logo.png' %}"></a>
            <h1 class="font-sans text-3xl font-bold text-center mt-5">We've Sent You a WhatsApp Message, Reply 'Yes' to Confirm Register</h1>
            <div class="mt-7 flex flex-col justify-center">
                <label for="whatsapp_phone_number" class="font-sans text-sm font-bold uppercase text-slate-400">WhatsApp Phone Number</label>
                <input name="whatsapp_phone_number" value="+{{ country_code }}{{ national_number }}" placeholder="E.g., +14155552671" type="text" class="block w-full border rounded-md py-3 px-5 mt-2 font-sans" disabled>
                <button type="submit" class="w-full py-4 px-7 font-bold text-white rounded-xl bg-green-500 hover:bg-green-600 mt-6 shadow-md">WhatsApp Me</button>
                <div class="text-center font-sans text-base mt-2 px-1">A confirmation message was sent to your phone number via WhatsApp. Reply 'yes' to register and login.</div>
            </div>
        </form>
    </div>
</div>
{% endblock %}

{% comment %}
Unrendered Javascript. We put the in an unrendered block so we can take advantage of the code editor's code highlighting feature.
Minify with https://www.minifier.org/
{% endcomment %}
{% block unrendered_javascript %}
<script>
var poll_status = function() {
    var start_poll = function () {
        var counter = 1000; // Poll for 50 minutes at most (1000 * 3s = 50 mins)
        var set_interval = setInterval(function() {
            // Get register token and ascertain if it has been activated.
            $.get("{% url 'relationships:confirm_register' user_uuid %}", function(data) {
                if (data['logged_in'] == true) {
                    window.location.replace('{{ next }}');
                }
            });
            counter--;
            if (counter < 0) {
                clearInterval(set_interval); // Stop this counter.
            }
        }, 3000); // Poll every 3 seconds.
    }

    return {
        init: function () {
            start_poll();
        }
    }
}();

$(document).ready(function () {
    poll_status.init();
});
</script>
{% endblock %}

{% block other_script %}
<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>{% comment %} Do not use the slim version, which does not have the .get function. {% endcomment %}
<script>
var poll_status=function(){var start_poll=function(){var counter=1000;var set_interval=setInterval(function(){$.get("{% url 'relationships:confirm_register' user_uuid %}",function(data){if(data.logged_in==!0){window.location.replace('{{ next }}')}});counter--;if(counter<0){clearInterval(set_interval)}},3000)}
return{init:function(){start_poll()}}}();$(document).ready(function(){poll_status.init()})
</script>
{% endblock %}