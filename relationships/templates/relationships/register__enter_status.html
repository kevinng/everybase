{% extends 'relationships/extendables/simple.html' %}

{% block title %}Set Your Status{% endblock %}

{% load static %}

{% block content %}
<div class="d-flex flex-column flex-column-fluid bgi-position-y-bottom position-x-center bgi-no-repeat bgi-size-contain bgi-attachment-fixed">
    <div class="d-flex flex-center flex-column flex-column-fluid p-10 pb-lg-20">
        <a href="{% url 'home' %}" class="mb-12">
            <img alt="Logo" src="{% static 'common/demo1/dist/assets/media/logos/logo.png' %}" />
        </a>

        <div class="w-lg-500px col-12 bg-body rounded shadow-sm p-10 p-lg-15 mx-auto">
            <form class="form w-100" action="{% url 'register:enter_status' user.id %}" method="post" x-data="{
                status: {% if form.status.value != None %}'{{ form.status.value }}'{% else %}''{% endif %},
                disableSubmit() {
                    let num_files_uploading = $refs.num_files_processing.value - $refs.num_files_success.value - $refs.num_files_error.value - $refs.num_files_removed.value
                    return this.status.length <= 0 || num_files_uploading > 0
                }
            }">
                {% csrf_token %}
                {% if form.next.value != None %}<input type="hidden" name="next" value="{{ form.next.value }}" />{% endif %}
                <input type="hidden" name="form_uuid" value="{{ form_uuid }}" />
                <input type="hidden" id="num_files_processing" value="0" x-ref="num_files_processing" />
                <input type="hidden" id="num_files_success" value="0" x-ref="num_files_success" />
                <input type="hidden" id="num_files_error" value="0" x-ref="num_files_error" />
                <input type="hidden" id="num_files_removed" value="0" x-ref="num_files_removed" />

                <div class="text-center mb-10">
                    <h1 class="text-dark mb-3">Set Your Status</h1>
                    <span class="mt-3 text-gray-700 fs-5">Your status let others know what you're interested in. E.g., buying, selling, looking for agents.</span>
                    {% if form.status.errors %}<div class="text-danger mt-2 ms-2">{% for error in form.status.errors %}{{ error|escape }}{% if not forloop.last %} {% endif %}{% endfor %}</div>{% endif %}
                </div>

                <div class="mt-6">
                    <label class="form-label fs-6 fw-bolder text-dark" for="status">Status</label>
                    <textarea maxlength="500" x-model="status" class="form-control" rows="3" data-kt-autosize="true" maxlength="100" id="status" name="status" placeholder="E.g., I sell paper and I'm looking for buyers..."></textarea>
                    <div class="form-text">What are you interested in?</div>
                </div>

                <div class="mt-6">
                    <div class="dropzone" id="status_dropzone">
                        <div class="dz-message needsclick">
                            <i class="bi bi-file-earmark-arrow-up text-primary fs-3x"></i>
                            <div class="ms-4">
                                <h3 class="fs-5 fw-bold text-gray-900 mb-1">Drop images here or click to upload.</h3>
                                <span class="fs-7 fw-semibold text-gray-400">Upload up to {{ settings.MAX_STATUS_IMAGES }} images.</span>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="text-center mt-10">
                    <button type="submit" class="btn btn-lg btn-primary w-100 mb-5" x-bind:disabled="disableSubmit" id="submit">Done</button>
                </div>
            </form>
        </div>
    </div>
</div>
{% endblock %}

{% comment %}
// These fields will not be minified because they contain rendered values.
const uploadStatusImageURL = "{% url 'users:upload_status_file' user.id %}"
const formUUID = "{{ form_uuid }}"
const maxFiles = {{ settings.MAX_STATUS_IMAGES }}
const maxFileSize = {{ settings.MAX_STATUS_IMAGE_FILE_SIZE_IN_BYTES }}
const deleteStatusImageURL = "{% url 'users:delete_status_file' user.id %}"

$(document).ready(function() {
    // We use hidden fields to bridge JQuery and Alpine JS.
    const numFilesProcessing = $('#num_files_processing')
    const numFilesSuccess = $('#num_files_success')
    const numFilesError = $('#num_files_error')
    const numFilesRemoved = $('#num_files_removed')

    // Helper function to return the number of images in upload.
    function numFilesUploading() {
        // Removed = Success + Error
        a = parseInt(numFilesProcessing.val()) - parseInt(numFilesRemoved.val())
        b = parseInt(numFilesProcessing.val()) - parseInt(numFilesSuccess.val()) - parseInt(numFilesError.val())
        if (a > b) { return b }
        return a
    }

    // Helper function to increment number of images processing
    function plusNumFilesProcessing() {
        numFilesProcessing.val(parseInt(numFilesProcessing.val()) + 1)
    }

    // Helper function to increment number of images removed
    function plusNumFilesRemoved() {
        numFilesRemoved.val(parseInt(numFilesRemoved.val()) + 1)
    }

    // Helper function to increment number of images error
    function plusNumFilesError() {
        numFilesError.val(parseInt(numFilesError.val()) + 1)
    }

    // Helper function to increment number of images success
    function plusNumFilesSuccess() {
        numFilesSuccess.val(parseInt(numFilesSuccess.val()) + 1)
    }

    // Helper function to generate UUID.
    function uuidv4() {
        return ([1e7]+-1e3+-4e3+-8e3+-1e11).replace(/[018]/g, c =>
            (c ^ crypto.getRandomValues(new Uint8Array(1))[0] & 15 >> c / 4).toString(16)
        )
    }

    // Enable save button (if conditions are right).
    function enableSubmit() {
        if ($('#status').val().length > 0 && numFilesUploading() <= 0) {
            $('#submit').removeAttr('disabled')
        }
    }

    // Disable save button
    function disableSubmit() {
        $('#submit').attr('disabled', true)
    }
    
    var status_dropzone = new Dropzone("#status_dropzone", {
        url: uploadStatusImageURL,
        params: { form_uuid: formUUID },
        paramName: "file",
        acceptedFiles: "image/*",
        maxFiles: maxFiles,
        maxFilesize: maxFileSize,
        addRemoveLinks: true,
        renameFile: function (file) {
            uuid = uuidv4()
            return uuid
        },
        init: function () {
            this.on("processing", function (file) {
                disableSubmit()
                plusNumFilesProcessing()
            })

            this.on("success", function (file, response) {
                plusNumFilesSuccess()
                enableSubmit()
            })

            this.on("error", function (file, error, xhr) {
                plusNumFilesError()
                enableSubmit()
            })

            this.on("removedfile", function (file, error, xhr) {
                let headers = new Headers()
                headers.append('Accept', 'application/json')
                headers.append('Content-Type', 'application/json')
                fetch(
                    deleteStatusImageURL, {
                    method: 'POST',
                    mode: 'same-origin',
                    credentials: 'include',
                    redirect: 'follow',
                    headers: headers,
                    body: JSON.stringify({
                        file_uuid: file.upload.filename,
                        form_uuid: formUUID
                    })
                })

                // We put these functions outside fetch.then because hiding the
                // form will trigger the remove callback if there are images
                // in the dropzone.
                plusNumFilesRemoved()
                enableSubmit()
            })
        }
    })
})
{% endcomment %}
{% block page_custom_javascript %}
<script>
// These fields will not be minified because they contain rendered values.
const uploadStatusImageURL = "{% url 'users:upload_status_file' user.id %}"
const formUUID = "{{ form_uuid }}"
const maxFiles = {{ settings.MAX_STATUS_IMAGES }}
const maxFileSize = {{ settings.MAX_STATUS_IMAGE_FILE_SIZE_IN_BYTES }}
const deleteStatusImageURL = "{% url 'users:delete_status_file' user.id %}"
</script>
<script src="{% static 'common/js/register__enter_status/dropzone.js' %}"></script>
{% endblock %}