{% extends 'extendables/base_simple.html' %}

{% load static %}

{% block head_bottom %}
<script type="text/javascript">
(function(e,t){var r=e.amplitude||{_q:[],_iq:{}};var n=t.createElement("script")
;n.type="text/javascript"
;n.integrity="sha384-4rr7CTymHc64YjTTL6O3ktfsHYI1yJnQdmKv4zFoe+frjXb05MfzzuLLIAgJ/XHs"
;n.crossOrigin="anonymous";n.async=true
;n.src="https://cdn.amplitude.com/libs/amplitude-8.11.0-min.gz.js"
;n.onload=function(){if(!e.amplitude.runQueuedFunctions){
console.log("[Amplitude] Error: could not load SDK")}}
;var s=t.getElementsByTagName("script")[0];s.parentNode.insertBefore(n,s)
;function i(e,t){e.prototype[t]=function(){
this._q.push([t].concat(Array.prototype.slice.call(arguments,0)));return this}}
var o=function(){this._q=[];return this}
;var a=["add","append","clearAll","prepend","set","setOnce","unset","preInsert","postInsert","remove"]
;for(var c=0;c<a.length;c++){i(o,a[c])}r.Identify=o;var u=function(){this._q=[]
;return this}
;var p=["setProductId","setQuantity","setPrice","setRevenueType","setEventProperties"]
;for(var l=0;l<p.length;l++){i(u,p[l])}r.Revenue=u
;var d=["init","logEvent","logRevenue","setUserId","setUserProperties","setOptOut","setVersionName","setDomain","setDeviceId","enableTracking","setGlobalUserProperties","identify","clearUserProperties","setGroup","logRevenueV2","regenerateDeviceId","groupIdentify","onInit","logEventWithTimestamp","logEventWithGroups","setSessionId","resetSessionId","setLibrary","setTransport"]
;function v(e){function t(t){e[t]=function(){
e._q.push([t].concat(Array.prototype.slice.call(arguments,0)))}}
for(var r=0;r<d.length;r++){t(d[r])}}v(r);r.getInstance=function(e){
e=(!e||e.length===0?"$default_instance":e).toLowerCase()
;if(!Object.prototype.hasOwnProperty.call(r._iq,e)){r._iq[e]={_q:[]};v(r._iq[e])
}return r._iq[e]};e.amplitude=r})(window,document);
{% comment %}
Everybase user has been created when this page is loaded, so we're able to provide the user's UUID even though registration has not completed.
{% endcomment %}
amplitude.getInstance().init("{{ amplitude_api_key }}", "{{ user_uuid }}");
</script>
{% endblock %}

{% block main %}
<div class="d-flex flex-column flex-root">
    <div class="d-flex flex-column flex-column-fluid bgi-position-y-bottom position-x-center bgi-no-repeat bgi-size-contain bgi-attachment-fixed" style="background-image: url({% static 'common/assets/media/illustrations/sketchy-1/14.png' %}">
        <!--begin::Content-->
        <div class="d-flex flex-center flex-column flex-column-fluid p-10 pb-lg-20">
            <!--begin::Logo-->
            <a href="../../demo1/dist/index.html" class="mb-12">
                <img alt="Logo" src="{% static 'common/assets/media/logos/plain-logo.png' %}" class="h-40px" />
            </a>
            <!--end::Logo-->
            <!--begin::Wrapper-->
            <div class="w-lg-500px bg-body rounded shadow-sm p-10 p-lg-15 mx-auto">
                <!--begin::Form-->
                <form class="form w-100" action="{% url 'relationships:register_link' user_uuid %}" method="post">
                    {% csrf_token %}
                    {% if next is not None %}<input type="hidden" name="next" value="{{ next }}">{% endif %}
                    <div class="text-center mb-10">
                        <h2 class="text-dark mb-3">We've sent you a WhatsApp message, please reply 'yes' to complete registration.</h1>
                    </div>
                    <div class="fv-row mb-3">
                        <label for="whatsapp_phone_number" class="form-label fs-6 fw-bolder text-dark">Your WhatsApp Phone Number</label>
                        <div class="d-flex d-flex-column">
                            <input name="whatsapp_phone_number" class="form-control form-control-lg" type="text" placeholder="e.g., +14155552671" disabled="true" value="+{{ country_code }}{{ national_number }}" />
                        </div>
                    </div>
                    <div class="text-center">
                        <button type="submit" class="btn btn-lg btn-success w-100 mb-5" id="register_link__resend_button">
                            Resend Link via WhatsApp
                        </button>
                    </div>
                    {% comment %} <div class="row">
                        <div class="col-12">
                            Wait <span class="text-light-info fw-bolder bg-info" id="register_link__counter_seconds">60</span> seconds to resend link.
                        </div>
                        <div class="col-12 fw-bold mt-3">
                            Refresh this page if you're not automatically logged in after you've replied 'yes' to our message.
                        </div>
                    </div> {% endcomment %}
                </form>
                <!--end::Form-->
            </div>
            <!--end::Wrapper-->
        </div>
        <!--end::Content-->
    </div>
</div>

{% endblock %}

{% block page_custom_script %}
<script type="text/javascript">

{% comment %} var register_link__counter = function () {
    var start_counter = function() {
        var counter = 59; // Seconds (begins as 60 in HTML)
        var set_interval = setInterval(function() {
            $('#register_link__counter_seconds').html('' + counter);
            counter--;
            if (counter < 0) {
                clearInterval(set_interval); // Stop this counter
                $('#register_link__resend_button').removeAttr('disabled') // Enable resend button
            }
        }, 1000);
    };

    return {
        init: function () {
            start_counter();
        }
    }
}(); {% endcomment %}

var register_link__poll_status = function() {
    var start_poll = function () {
        var counter = 1000 // Poll for 33.3 minutes at most (1000 * 2s = 33.3 mins)
        var logged = false
        var set_interval = setInterval(function() {
            // Get register token and ascertain if it has been activated
            $.get("{% url 'relationships:confirm_register' user_uuid %}", function(data) {
                if (data['logged_in'] == true) {
                    // Set user properties
                    if (logged == false) {
                        var identify = new amplitude.Identify()
                            .set('country code', '{{ country_code }}')
                            .set('last seen date time', '{{ last_seen_date_time }}')
                            .set('num whatsapp lead author', {{ num_whatsapp_lead_author }})
                            .set('num leads created', {{ num_leads_created }})
                        amplitude.getInstance().identify(identify)

                        // Log event
                        amplitude.getInstance().logEvent('account - registered')

                        logged = true // Log once only
                    }

                    next = {% if next is not None %}'{{ next }}'{% else %}"{% url 'leads__root:list' %}"{% endif %}
                    window.location.replace(next);
                }
            });
            counter--;
            if (counter < 0) {
                clearInterval(set_interval); // Stop this counter
            }
        }, 2000); // Poll every 2 seconds
    }

    return {
        init: function () {
            start_poll();
        }
    }
}();

jQuery(document).ready(function () {
    {% comment %} register_link__counter.init(); {% endcomment %}
    register_link__poll_status.init();
});

</script>
{% endblock %}