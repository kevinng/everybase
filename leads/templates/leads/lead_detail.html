{% extends 'extendables/b.html' %}

{% load static %}
{% load string_equal %}

{% comment %} TODO {% endcomment %}
{% comment %} Put in all the on-page SEO here {% endcomment %}
{% comment %} Include keywords {% endcomment %}
{% comment %}
Title is optimized for SEO purposes. String format:
- Buyer or seller
- If buying, source country. If selling, destination country.
- Goods/services keywords
We want to cache the title, so the code doesn't have to run each and everytime the page is loaded
{% endcomment %}

{% block title %}{{ lead.seo_title }}{% endblock %}

{% block other_head_tags %}
{% endblock %}

{% block other_css %}
<link href="{% static 'common/photoswipe/photoswipe.min.css' %}" rel="stylesheet" />
<link href="{% static 'common/photoswipe/default-skin/default-skin.min.css' %}" rel="stylesheet" />
{% endblock %}

{% block page_actions %}
{% comment %} WRONG {% endcomment %}
{% include 'relationships/includes/user_detail_actions.html' with detail_user=lead.author %}
{% endblock %}

{% block content %}
<div class="flex flex-col lg:flex-row justify-center mt-10 mb-10 gap-2">
    {% comment %} start: user detail side {% endcomment %}
    {% comment %} This user detail will only show on larger screen sizes. We want user detail to show after lead details on smaller screens. {% endcomment %}
    {% include 'relationships/includes/user_detail_side.html' with detail_user=lead.author responsive_classes='hidden lg:block lg:w-1/3 xl:w-1/4 lg:self-start' %}
    {% comment %} end: user detail side {% endcomment %}

    {% comment %} start: details and comments {% endcomment %}
    <div class="w-full lg:w-1/2 lg:mt-0 mt-4">

        {% comment %} start: details {% endcomment %}
        <div class="bg-white rounded px-8 py-8 shadow-md">
            <div class="flex items-start justify-between">
                <div class="text-xl font-bold">{% if lead.lead_type == 'buying' %}Buying{% elif lead.lead_type == 'selling' %}Selling{% endif %}, {% if lead.author_type == 'direct' %}Direct {% if lead.lead_type == 'buying' %}Buyer{% elif lead.lead_type == 'selling' %}Seller{% endif %}{% elif lead.author_type == 'broker' %}Middleman{% endif %}</div>
                <div class="text-sm">{{ lead.age_desc }}</div>
            </div>

            {% comment %} start: thumbnails {% endcomment %}
            <div class="flex items-start justify-start mt-4 gap-2 image-gallery" itemscope itemtype="http://schema.org/ImageGallery">
                {% load thumbnail_url %}
                {% load image_url %}
                {% for file in lead.files.all %}
                    {% thumbnail_url file as thumbnail_url %}
                    {% image_url file as image_url %}
                    <figure itemprop="associatedMedia" itemscope itemtype="http://schema.org/ImageObject">
                        <a href="{{ image_url }}" itemprop="contentUrl" data-size="{{ file.width }}x{{ file.height }}">
                            <img src="{{ thumbnail_url }}" itemprop="thumbnail" class="shadow-md">
                        </a>
                    </figure>
                {% endfor %}
            </div>
            {% comment %} end: thumbnails {% endcomment %}

            {% comment %} start: buy_country {% endcomment %}
            <div class="font-bold text-slate-400 mt-6">{% if lead.lead_type == 'selling' %}Source Country{% elif lead.lead_type == 'buying' %}Buy From This Country{% endif %}</div>
            <div class="mt-1">{% if lead.buy_country is not None %}{{ lead.buy_country.name }}{% else %}Any Country{% endif %}</div>
            <div class="mt-1 italic">{% if lead.lead_type == 'selling' %}Country the goods/services are exported from or based in.{% elif lead.lead_type == 'buying' %}Country buyer would like to buy or source from.{% endif %}</div>
            {% comment %} end: buy_country {% endcomment %}

            {% comment %} start: sell_country {% endcomment %}
            <div class="font-bold text-slate-400 mt-4">{% if lead.lead_type == 'selling' %}Sell In This Country{% elif lead.lead_type == 'buying' %}Destination Country{% endif %}</div>
            <div class="mt-1">{% if lead.sell_country is not None %}{{ lead.sell_country.name }}{% else %}Any Country{% endif %}</div>
            <div class="mt-1 italic">{% if lead.lead_type == 'selling' %}Country seller would like to sell the goods/services in.{% elif lead.lead_type == 'buying' %}Country the goods/services are imported into or needed.{% endif %}</div>
            {% comment %} end: sell_country {% endcomment %}

            {% comment %} start: details {% endcomment %}
            <div class="font-bold text-slate-400 mt-4">Goods/Services Details</div>
            <div class="mt-1 break-words">{{ lead.details }}</div>
            {% comment %} end: details {% endcomment %}
            
            {% comment %} start: need_agent {% endcomment %}
            {% if lead.need_agent %}
                <div class="text-xl font-bold mt-6">I need selling or promoting agents</div>

                {% if lead.commission_type == 'percentage' %}

                {% comment %} start: commission {% endcomment %}
                <div class="font-bold text-slate-400 mt-4">Agent Commission</div>
                <div class="mt-1">{{ lead.commission }} % of Sales</div>
                {% comment %} end: commission {% endcomment %}

                {% comment %} start: avg_deal_size {% endcomment %}
                <div class="font-bold text-slate-400 mt-4">Average Deal Size</div>
                <div class="mt-1">USD {{ lead.avg_deal_size|floatformat:2 }}</div>
                {% comment %} end: avg_deal_size {% endcomment %}

                {% comment %} start: avg_deal_comm {% endcomment %}
                <div class="font-bold text-slate-400 mt-4">Average Earnings Per Deal</div>
                <div class="mt-1">USD {{ lead.avg_deal_comm|floatformat:2 }}</div>
                {% comment %} end: avg_deal_comm {% endcomment %}

                {% comment %} start: commission_payable_after {% endcomment %}
                <div class="font-bold text-slate-400 mt-4">Commission Payable After</div>
                <div class="mt-1">{% if lead.commission_payable_after == 'initial_deposit_received' %}Initial Deposit Received{% elif lead.commission_payable_after == 'goods_shipped' %}Goods Shipped{% elif lead.commission_payable_after == 'buyer_received_goods_services' %}Buyer Received Goods/Services{% elif lead.commission_payable_after == 'full_payment_received' %}Full Payment Received{% elif lead.commission_payable_after == 'other' %}{{ lead.commission_payable_after_other }}{% endif %}</div>
                {% comment %} end: commission_payable_after {% endcomment %}

                {% comment %} start: other_agent_details {% endcomment %}
                <div class="font-bold text-slate-400 mt-4">Other Details For {% if lead.lead_type == 'selling' %}Selling{% elif lead.lead_type == 'buying' %}Buying{% endif %} Agent</div>
                <div class="mt-1 break-words">{{ lead.other_agent_details }}</div>
                {% comment %} end: other_agent_details {% endcomment %}

                {% elif lead.commission_type == 'other' %}

                <div class="font-bold text-slate-400 mt-4">{% if lead.lead_type == 'selling' %}Selling{% elif lead.lead_type == 'buying' %}Buying{% endif %} Agent Commission</div>
                <div class="mt-1 break-words">{{ lead.commission_type_other }}</div>

                {% endif %}

                {% comment %} start: is_comm_negotiable {% endcomment %}
                {% if lead.is_comm_negotiable == True %}
                <div class="italic mt-4">Commission may differ and is negotiable for each deal.</div>
                {% endif %}
                {% comment %} end: is_comm_negotiable {% endcomment %}

            {% endif %}
            {% comment %} end: need_agent {% endcomment %}

            {% if lead.need_logistics_agent %}
                <div class="text-xl font-bold mt-6">I need logistics agents</div>

                <div class="font-bold text-slate-400 mt-4">Logistics Needs</div>
                <div class="mt-1 break-words">{{ lead.other_logistics_agent_details }}</div>
            {% endif %}

            <div class="flex justify-end mt-8">
                {% if user.is_authenticated == True and user.user.id == lead.author.id %}
                    <a href="{% url 'leads:lead_edit' lead.id %}" class="px-6 py-2 ml-2 text-slate-600 shadow-md bg-slate-100 hover:bg-slate-200 rounded-md">Edit</a>
                {% elif user.user.id != lead.author.id %}
                    {% if user.is_authenticated == True %}
                        {% comment %} Allow toggling of save-unsave asynchronously {% endcomment %}
                        {% load has_saved_lead %}
                        {% has_saved_lead user.user lead as has_saved_lead %}
                        <button id="toggle_save_lead" class="py-2 px-4 mt-2 rounded-md shadow-md {% if has_saved_lead == True %}text-white bg-blue-500 hover:bg-blue-600{% else %}text-slate-600 bg-slate-100 hover:bg-slate-200{% endif %}">{% if has_saved_lead == True %}Lead Saved{% else %}Save Lead{% endif %}</button>
                    {% else %}
                        {% comment %} Direct user to login and come back to this page with lead saved {% endcomment %}
                        <a href="" class="py-2 px-4 mt-2 rounded-md text-slate-600 shadow-md bg-slate-100 hover:bg-slate-200">Save Lead</a>
                    {% endif %}
                {% endif %}
            </div>
        </div>
        {% comment %} end: details {% endcomment %}

        {% comment %} start: user detail side {% endcomment %}
        {% comment %} This user detail will only show on smaller screen sizes. We want user detail to show after lead details on smaller screens. {% endcomment %}
        {% include 'relationships/includes/user_detail_side.html' with detail_user=lead.author responsive_classes='lg:hidden mt-2' %}
        {% comment %} end: user detail side {% endcomment %}

        {% comment %} start: main comment box
            For starting a new comment thread on this lead.
            Shown always, to this and detail user. I.e., anyone may start a new comment any time.
        {% endcomment %}
        {% comment %} id="comment-starter" is used by our JavaScript code to focus on this section {% endcomment %}
        <div id="comment-starter" class="comment bg-white rounded px-8 py-8 shadow-md mt-2"{% if not form.comment_id.value and form.body.errors %} focus-comment-box="yes"{% endif %}>
            <div class="text-xl font-bold text-center">Comment On This Lead</div>
            <div class="flex flex-col items-center justify-center mt-2">
                <form action="{% url 'leads:lead_detail' lead.slug_link %}" class="check-to-enable comment-box" method="post">
                    {% csrf_token %}
                    <textarea name="body" rows="4" type="text" class="growing w-full border rounded-md py-3 px-5 mt-2" placeholder="Enter comments">{% if not form.comment_id.value and form.body.value %}{{ form.body.value }}{% endif %}</textarea>
                    {% if not form.comment_id.value and form.body.errors is not None %}
                        <div class="px-1 mt-2 text-red-500">{% for error in form.body.errors %}{{ error|escape }}{% if not forloop.last %} {% endif %}{% endfor %}</div>
                    {% endif %}
                    <button type="submit" class="check-to-enable-button py-2 px-4 rounded-md shadow-md mt-2 text-white bg-blue-500 hover:bg-blue-600 w-full text-lg">Comment</button>
                    <div class="flex flex-col items-center px-2 mt-2">
                        <div class="flex justify-start">
                            <input id="comment-enable-checkbox-starter" type="checkbox" class="check-to-enable-checkbox h-6 w-6 flex-none">
                            <label for="comment-enable-checkbox-starter" class="ml-3">I know you sell credits for users to contact others. So, I didn't include contact details in my reply. Let's help each other grow our businesses 😊</label>
                        </div>
                        <div class="font-semibold mt-2 text-center"><span class="text-red-500">WARNING:</span> phone numbers of users who share contact details in comments will be banned.</div>
                    </div>
                </form>

                <div class="mt-8 text-center">Comments do <span class="underline underline-offset-1">not</span> cost credits.</div>

                <a href="{% url 'pricing' %}" class="py-2 px-3 text-slate-600 shadow-md bg-slate-100 hover:bg-slate-200 rounded-md mt-4">Learn About Credits</a>
            </div>
        </div>

        {% comment %} start: root comments {% endcomment %}
        {% for root_comment in lead.root_comments %}
            {% string_equal form.comment_id.value root_comment.id as is_this_comment %}

            <div class="comment bg-white rounded px-8 py-8 shadow-md mt-2"{% if is_this_comment and form.body.errors %} focus-comment-box="yes"{% endif %}>
                <div id="comment-{{ root_comment.id }}" class="flex justify-between items-center">
                    {% comment %} TODO add link {% endcomment %}
                    <a href="{% url 'users:user_detail' root_comment.commentor.id %}" class="font-bold">{{ root_comment.commentor.first_name }} {{ root_comment.commentor.last_name }}, {{ root_comment.commentor.country.name }}</a>
                    <div class="text-sm">{{ root_comment.age_desc }}</div>
                </div>
                <div class="mt-4 break-words">{{ root_comment.body }}</div>

                {% comment %} start: replies {% endcomment %}
                {% for reply in root_comment.reply_comments %}
                    {% comment %} id="comment-{{ reply.id }}" is used by our JavaScript code to focus on this section {% endcomment %}
                    <div id="comment-{{ reply.id }}" class="mt-4">
                        <div class="flex justify-between items-center">
                            <a href="{% url 'users:user_detail' root_comment.commentor.id %}" class="font-bold ml-8">{{ reply.commentor.first_name }} {{ reply.commentor.last_name }}, {{ reply.commentor.country.name }}</a>
                            <div class="text-sm">{{ reply.age_desc }}</div>
                        </div>
                        <div class="mt-2 pl-8 break-words">{{ reply.body }}</div>
                    </div>
                {% endfor %}
                {% comment %} end: replies {% endcomment %}
                
                {% comment %} start: reply {% endcomment %}
                <div class="flex justify-end">
                    <button id="comment-reply-show-{{ root_comment.id }}" class="reply-show py-2 px-3 text-slate-600 shadow-md bg-slate-100 hover:bg-slate-200 rounded-md mt-4">Reply</button>
                </div>
                {% comment %} end: reply {% endcomment %}

                {% comment %} start: reply box {% endcomment %}
                {% comment %} id="comment-reply-box-{{ root_comment.id }}" is used by our JavaScript code to focus on this section {% endcomment %}
                <form id="comment-reply-box-{{ root_comment.id }}" action="{% url 'leads:lead_detail' lead.slug_link %}" class="reply-box check-to-enable flex flex-col justify-center" method="post">
                    {% csrf_token %}
                    <input type="hidden" name="comment_id" value="{{ root_comment.id }}">
                    <textarea name="body" rows="4" type="text" class="growing w-full border rounded-md py-3 px-5 mt-4" placeholder="Enter reply">{% if is_this_comment and form.body.value %}{{ form.body.value }}{% endif %}</textarea>
                    {% if is_this_comment and form.body.errors is not None %}
                        <div class="px-1 mt-2 text-red-500">{% for error in form.body.errors %}{{ error|escape }}{% if not forloop.last %} {% endif %}{% endfor %}</div>
                    {% endif %}
                    <button type="submit" class="check-to-enable-button py-2 px-4 rounded-md shadow-md mt-2 text-white bg-blue-500 hover:bg-blue-600 w-full text-lg">Comment</button>
                    <div class="flex flex-col items-center px-2 mt-2">
                        <div class="flex justify-start">
                            <input id="comment-enable-checkbox-{{ root_comment.id }}" type="checkbox" class="check-to-enable-checkbox h-6 w-6 flex-none">
                            <label for="comment-enable-checkbox-{{ root_comment.id }}" class="ml-3">I know you sell credits for users to contact others. So, I didn't include contact details in my reply. Let's help each other grow our businesses 😊</label>
                        </div>
                        <div class="font-semibold mt-2 text-center"><span class="text-red-500">WARNING:</span> phone numbers of users who share contact details in comments will be banned.</div>
                    </div>

                    <div class="mt-8 text-center">Replies do <span class="underline underline-offset-1">not</span> cost credits.</div>

                    <div class="flex justify-center">
                        <a href="{% url 'pricing' %}" class="py-2 px-3 text-slate-600 shadow-md bg-slate-100 hover:bg-slate-200 rounded-md mt-4">Learn About Credits</a>
                    </div>
                </form>
                {% comment %} end: reply box {% endcomment %}
            </div>
        {% endfor %}
        {% comment %} end: root comments {% endcomment %}
    </div>
    {% comment %} end: details {% endcomment %}
</div>
{% comment %} PhotoSwipe library HTML code to be inserted before end of body tag. {% endcomment %}
{% include 'includes/photoswipe.html' %}
{% endblock %}

{% comment %}
Dependences:
    JQuery

$(document).ready(function() {
    // Save/unsave user
    $toggle_save_user = $('#toggle_save_user')
    $toggle_save_user.click(function () {
        // Make AJAX call to save user, and update button look.
        $.ajax({
            type: 'POST',
            url: "{% url 'users:toggle_save_user' lead.author.id %}",
            dataType: 'json',
            success: function (data) {
                if (data['s'] == true) {
                    $toggle_save_user
                        .removeClass('text-slate-600 bg-slate-100 hover:bg-slate-200')
                        .addClass('text-white bg-blue-500 hover:bg-blue-600')
                        .text('Person Saved')
                } else {
                    $toggle_save_user
                        .addClass('text-slate-600 bg-slate-100 hover:bg-slate-200')
                        .removeClass('text-white bg-blue-500 hover:bg-blue-600')
                        .text('Save Person')
                }
            }
        })
    })
    
    // Save/unsave lead
    $toggle_save_lead = $('#toggle_save_lead')
    $toggle_save_lead.click(function () {
        // Make AJAX call to save lead, and update button look.
        $.ajax({
            type: 'POST',
            url: "{% url 'leads:toggle_save_lead' lead.id %}",
            dataType: 'json',
            success: function (data) {
                if (data['s'] == true) {
                    $toggle_save_lead
                        .removeClass('text-slate-600 bg-slate-100 hover:bg-slate-200')
                        .addClass('text-white bg-blue-500 hover:bg-blue-600')
                        .text('Lead Saved')
                } else {
                    $toggle_save_lead
                        .addClass('text-slate-600 bg-slate-100 hover:bg-slate-200')
                        .removeClass('text-white bg-blue-500 hover:bg-blue-600')
                        .text('Save Lead')
                }
            }
        })
    })

    // Enable or disable corresponding button based on checkbox state
    function set_enable_button_checkbox(button, checkbox) {
        if (checkbox.is(':checked')) {
            button.removeAttr('disabled')
            button.addClass('bg-blue-500 hover:bg-blue-600')
            button.removeClass('bg-blue-200')
        } else {
            button.prop('disabled', true)
            button.removeClass('bg-blue-500 hover:bg-blue-600')
            button.addClass('bg-blue-200')
        }
    }

    // Initialize each check-to-enable section
    $('.check-to-enable').each(function () {        
        // Initialize for the first time on page load
        set_enable_button_checkbox(
            $(this).find('.check-to-enable-button'),
            $(this).find('.check-to-enable-checkbox')
        )

        // Initialize on checkbox change
        $(this).find('.check-to-enable-checkbox').change(function () {
            $button = $(this).closest('.check-to-enable')
                .find('.check-to-enable-button')

            set_enable_button_checkbox($button, $(this))
        })
    })

    // Initialize comment reply boxes
    $('.comment').each(function () {
        if ($(this).attr('focus-comment-box') == 'yes') {
            // Hide reply button on load
            $reply_show = $(this).find('.reply-show')
            if ($reply_show.length > 0) {
                $reply_show.hide()
            }

            // Reply box is already shown

            // Focus on reply or comment box
            $reply_box = $(this).find('.reply-box')
            if ($reply_box.length > 0) {
                $('html, body').animate({
                    // 180 pixel from top looks good
                    scrollTop: $reply_box.offset().top - 180
                }, 500)
            } else {
                $comment_box = $(this).find('.comment-box')
                $('html, body').animate({
                    // 180 pixel from top looks good
                    scrollTop: $comment_box.offset().top - 180
                }, 500)
            }
        } else {
            // Hide reply boxes on load
            // Note: the one comment box at the top is not hidden
            $(this).find('.reply-box').hide()

            $(this).find('.reply-show').click(function () {
                // Show reply box and hide self
                $(this).closest('.comment').find('.reply-box').show()
                $(this).hide()
            })
        }
    })
})

Code to focus on the right section of the page
{% if focus %}
$(document).ready(function() {
    // Scroll to focus if a target exists
    $('html, body').animate({
        // 180 pixel from top looks good
        scrollTop: $("#{{ focus }}").offset().top - 180
    }, 500)
})
{% endif %}

{% endcomment %}
{% block other_script %}
<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script src="{% static 'common/photoswipe/photoswipe.min.js' %}"></script>
<script src="{% static 'common/photoswipe/photoswipe-ui-default.min.js' %}"></script>
<script src="{% static 'common/photoswipe/photoswipe-everybase.min.js' %}"></script>
<script src="{% static 'common/js/growing_text_areas.min.js' %}"></script>
<script>{% comment %} JS embedded here because server-side rendering is required. {% endcomment %}
$(document).ready((function(){function e(e,t){t.is(":checked")?(e.removeAttr("disabled"),e.addClass("bg-blue-500 hover:bg-blue-600"),e.removeClass("bg-blue-200")):(e.prop("disabled",!0),e.removeClass("bg-blue-500 hover:bg-blue-600"),e.addClass("bg-blue-200"))}$toggle_save_user=$("#toggle_save_user"),$toggle_save_user.click((function(){$.ajax({type:"POST",url:"{% url 'users:toggle_save_user' lead.author.id %}",dataType:"json",success:function(e){1==e.s?$toggle_save_user.removeClass("text-slate-600 bg-slate-100 hover:bg-slate-200").addClass("text-white bg-blue-500 hover:bg-blue-600").text("Person Saved"):$toggle_save_user.addClass("text-slate-600 bg-slate-100 hover:bg-slate-200").removeClass("text-white bg-blue-500 hover:bg-blue-600").text("Save Person")}})})),$toggle_save_lead=$("#toggle_save_lead"),$toggle_save_lead.click((function(){$.ajax({type:"POST",url:"{% url 'leads:toggle_save_lead' lead.id %}",dataType:"json",success:function(e){1==e.s?$toggle_save_lead.removeClass("text-slate-600 bg-slate-100 hover:bg-slate-200").addClass("text-white bg-blue-500 hover:bg-blue-600").text("Lead Saved"):$toggle_save_lead.addClass("text-slate-600 bg-slate-100 hover:bg-slate-200").removeClass("text-white bg-blue-500 hover:bg-blue-600").text("Save Lead")}})})),$(".check-to-enable").each((function(){e($(this).find(".check-to-enable-button"),$(this).find(".check-to-enable-checkbox")),$(this).find(".check-to-enable-checkbox").change((function(){$button=$(this).closest(".check-to-enable").find(".check-to-enable-button"),e($button,$(this))}))})),$(".comment").each((function(){"yes"==$(this).attr("focus-comment-box")?($reply_show=$(this).find(".reply-show"),$reply_show.length>0&&$reply_show.hide(),$reply_box=$(this).find(".reply-box"),$reply_box.length>0?$("html, body").animate({scrollTop:$reply_box.offset().top-180},500):($comment_box=$(this).find(".comment-box"),$("html, body").animate({scrollTop:$comment_box.offset().top-180},500))):($(this).find(".reply-box").hide(),$(this).find(".reply-show").click((function(){$(this).closest(".comment").find(".reply-box").show(),$(this).hide()})))}))}));
{% comment %} Code to focus on the right section {% endcomment %}{% if focus %}$(document).ready((function(){$("html, body").animate({scrollTop:$("#{{ focus }}").offset().top-180},500)}));{% endif %}
</script>
{% endblock %}